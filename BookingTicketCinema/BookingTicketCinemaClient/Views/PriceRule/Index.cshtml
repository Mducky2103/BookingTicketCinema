@model List<BookingTicketCinemaClient.Models.PriceRuleViewModel>
@{
  ViewData["Title"] = "Price Rule Manager";
  var seatGroups = ViewBag.SeatGroups as List<BookingTicketCinemaClient.Models.SeatGroupViewModel> ?? new List<BookingTicketCinemaClient.Models.SeatGroupViewModel>();
  // Read TempData into local variables to consume them immediately
  string? successMessage = TempData["SuccessMessage"]?.ToString();
  string? errorMessage = TempData["ErrorMessage"]?.ToString();
}

@* ************** Content ************** *@
<div class="row mb-4">
  <div class="col-12">
    <h4 class="fw-bold py-3 mb-4">Price Rule Manager</h4>
  </div>
</div>

@* Alerts *@
@if (!string.IsNullOrEmpty(successMessage))
{
  <div class="alert alert-success alert-dismissible mb-4" role="alert">
    <i class="icon-base bx bx-check-circle me-2"></i>
    @successMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="alert alert-danger alert-dismissible mb-4" role="alert">
    <i class="icon-base bx bx-error-circle me-2"></i>
    @errorMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}

@if (ViewBag.ErrorMessage != null)
{
  <div class="alert alert-danger alert-dismissible mb-4" role="alert">
    <i class="icon-base bx bx-error-circle me-2"></i>
    @ViewBag.ErrorMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}

<div class="row">
  <!-- Price Rules Table -->
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title m-0 me-2">Price Rules</h5>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPriceRuleModal">
          <i class="icon-base bx bx-plus me-1"></i>
          <span class="d-none d-sm-inline-block">Add New Price Rule</span>
        </button>
      </div>
      <div class="table-responsive text-nowrap">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Base Price</th>
              <th>Day of Week</th>
              <th>Time Slot</th>
              <th>Seat Group</th>
              <th>Showtime ID</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody class="table-border-bottom-0">
            @if (Model != null && Model.Any())
            {
              @foreach (var priceRule in Model)
              {
                <tr>
                  <td><strong>#@priceRule.PriceRuleId</strong></td>
                  <td>
                    <span class="fw-semibold text-primary">$@priceRule.BasePrice.ToString("F2")</span>
                  </td>
                  <td>
                    <span class="badge bg-label-info me-1">@priceRule.DayOfWeekName</span>
                  </td>
                  <td>
                    <span class="badge bg-label-@(priceRule.Slot == 0 ? "warning" : priceRule.Slot == 1 ? "primary" : priceRule.Slot == 2 ? "success" : "secondary") me-1">
                      @priceRule.SlotName
                    </span>
                  </td>
                  <td>
                    @if (!string.IsNullOrEmpty(priceRule.SeatGroupName))
                    {
                      <span class="text-body">@priceRule.SeatGroupName</span>
                    }
                    else
                    {
                      <span class="text-muted">Group #@priceRule.SeatGroupId</span>
                    }
                  </td>
                  <td>
                    @if (priceRule.ShowtimeId.HasValue)
                    {
                      <span class="text-body">#@priceRule.ShowtimeId</span>
                    }
                    else
                    {
                      <span class="text-muted">-</span>
                    }
                  </td>
                  <td>@priceRule.CreatedAt.ToString("MM/dd/yyyy")</td>
                  <td>
                    <div class="dropdown">
                      <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                        <i class="icon-base bx bx-dots-vertical-rounded"></i>
                      </button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item" href="javascript:void(0);" 
                           data-bs-toggle="modal" 
                           data-bs-target="#editPriceRuleModal"
                           data-pricerule-id="@priceRule.PriceRuleId"
                           data-pricerule-baseprice="@priceRule.BasePrice"
                           data-pricerule-dayofweek="@priceRule.DayOfWeek"
                           data-pricerule-slot="@priceRule.Slot"
                           data-pricerule-seatgroupid="@priceRule.SeatGroupId"
                           data-pricerule-showtimeid="@(priceRule.ShowtimeId?.ToString() ?? "")">
                          <i class="icon-base bx bx-edit-alt me-1"></i> Edit
                        </a>
                        <a class="dropdown-item" href="javascript:void(0);" 
                           onclick="confirmDelete(@priceRule.PriceRuleId, '@priceRule.PriceRuleId')">
                          <i class="icon-base bx bx-trash me-1"></i> Delete
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              }
            }
            else
            {
              <tr>
                <td colspan="8" class="text-center py-6">
                  <p class="text-body-secondary mb-0">No price rules found. Create your first price rule!</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create Price Rule Modal -->
<div class="modal fade" id="createPriceRuleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCenterTitle">Create New Price Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-controller="PriceRule" asp-action="Create" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label for="createPriceRuleBasePrice" class="form-label">Base Price ($)</label>
            <input type="number" class="form-control" id="createPriceRuleBasePrice" name="BasePrice" step="0.01" min="0" placeholder="0.00" required />
          </div>
          <div class="mb-3">
            <label for="createPriceRuleDayOfWeek" class="form-label">Day of Week</label>
            <select class="form-select" id="createPriceRuleDayOfWeek" name="DayOfWeek" required>
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="createPriceRuleSlot" class="form-label">Time Slot</label>
            <select class="form-select" id="createPriceRuleSlot" name="Slot" required>
              <option value="0">Morning</option>
              <option value="1">Afternoon</option>
              <option value="2">Evening</option>
              <option value="3">Late Night</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="createPriceRuleSeatGroupId" class="form-label">Seat Group</label>
            <select class="form-select" id="createPriceRuleSeatGroupId" name="SeatGroupId" required>
              <option value="">Select a seat group</option>
              @foreach (var seatGroup in seatGroups)
              {
                <option value="@seatGroup.SeatGroupId">@seatGroup.GroupName (@seatGroup.TypeName)</option>
              }
            </select>
          </div>
          <div class="mb-3">
            <label for="createPriceRuleShowtimeId" class="form-label">Showtime ID (Optional)</label>
            <input type="number" class="form-control" id="createPriceRuleShowtimeId" name="ShowtimeId" min="1" placeholder="Leave empty if not applicable" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Price Rule</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Price Rule Modal -->
<div class="modal fade" id="editPriceRuleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalCenterTitle">Edit Price Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editPriceRuleForm" method="post">
        <div class="modal-body">
          <input type="hidden" id="editPriceRuleId" name="id" />
          <div class="mb-3">
            <label for="editPriceRuleBasePrice" class="form-label">Base Price ($)</label>
            <input type="number" class="form-control" id="editPriceRuleBasePrice" name="BasePrice" step="0.01" min="0" placeholder="0.00" />
          </div>
          <div class="mb-3">
            <label for="editPriceRuleDayOfWeek" class="form-label">Day of Week</label>
            <select class="form-select" id="editPriceRuleDayOfWeek" name="DayOfWeek">
              <option value="">-- No Change --</option>
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editPriceRuleSlot" class="form-label">Time Slot</label>
            <select class="form-select" id="editPriceRuleSlot" name="Slot">
              <option value="">-- No Change --</option>
              <option value="0">Morning</option>
              <option value="1">Afternoon</option>
              <option value="2">Evening</option>
              <option value="3">Late Night</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editPriceRuleSeatGroupId" class="form-label">Seat Group</label>
            <select class="form-select" id="editPriceRuleSeatGroupId" name="SeatGroupId">
              <option value="">-- No Change --</option>
              @foreach (var seatGroup in seatGroups)
              {
                <option value="@seatGroup.SeatGroupId">@seatGroup.GroupName (@seatGroup.TypeName)</option>
              }
            </select>
          </div>
          <div class="mb-3">
            <label for="editPriceRuleShowtimeId" class="form-label">Showtime ID (Optional)</label>
            <input type="number" class="form-control" id="editPriceRuleShowtimeId" name="ShowtimeId" min="1" placeholder="Leave empty to clear" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Price Rule</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Form -->
<form id="deletePriceRuleForm" method="post" style="display: none;">
</form>

@section PageScripts {
<script>
  // Handle edit modal
  document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('editPriceRuleModal');
    if (editModal) {
      editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const priceRuleId = button.getAttribute('data-pricerule-id');
        const basePrice = button.getAttribute('data-pricerule-baseprice');
        const dayOfWeek = button.getAttribute('data-pricerule-dayofweek');
        const slot = button.getAttribute('data-pricerule-slot');
        const seatGroupId = button.getAttribute('data-pricerule-seatgroupid');
        const showtimeId = button.getAttribute('data-pricerule-showtimeid');

        document.getElementById('editPriceRuleId').value = priceRuleId;
        document.getElementById('editPriceRuleBasePrice').value = basePrice || '';
        document.getElementById('editPriceRuleDayOfWeek').value = dayOfWeek || '';
        document.getElementById('editPriceRuleSlot').value = slot || '';
        document.getElementById('editPriceRuleSeatGroupId').value = seatGroupId || '';
        document.getElementById('editPriceRuleShowtimeId').value = showtimeId || '';

        const form = document.getElementById('editPriceRuleForm');
        form.action = `/admin/pricerule/${priceRuleId}/update`;
      });
    }
  });

  // Handle delete confirmation
  function confirmDelete(priceRuleId, displayId) {
    if (confirm(`Are you sure you want to delete Price Rule #${displayId}? This action cannot be undone.`)) {
      const form = document.getElementById('deletePriceRuleForm');
      form.action = `/admin/pricerule/${priceRuleId}/delete`;
      form.submit();
    }
  }
</script>
}

