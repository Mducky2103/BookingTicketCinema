@page
@model BookingTicketCinema.WebApp.Pages.Movie.DetailsModel
@{
    ViewData["Title"] = Model.Movie?.Title ?? "Chi tiết Phim";
}

@if (Model.Movie != null)
{
    <div class="row">
        <div class="col-md-4">
            <img src="@(Model.ApiBaseUrl + Model.Movie.PosterUrl)" class="img-fluid rounded shadow-sm" alt="@Model.Movie.Title">
        </div>

        <div class="col-md-8">
            <h1>@Model.Movie.Title</h1>

            <div class="mb-3">
                @foreach (var genre in Model.Movie.Genre?.Split(',') ?? Enumerable.Empty<string>())
                {
                    <span class="badge bg-light text-dark border me-2">@genre.Trim()</span>
                }
            </div>

            <p class="text-muted">
                <i class="bi bi-clock"></i> @((int)Model.Movie.Duration.TotalMinutes) phút
                <span class="mx-2">|</span>
                <i class="bi bi-calendar-event"></i> @Model.Movie.ReleaseDate.ToString("dd/MM/yyyy")
            </p>

            <p>@Model.Movie.Description</p>

            @if (!string.IsNullOrEmpty(Model.Movie.TrailerUrl))
            {
                <h5 class="mt-4">Trailer</h5>
                <div class="ratio ratio-16x9">
                    <iframe src="@Model.Movie.TrailerUrl"
                            title="Trailer"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                    </iframe>
                </div>
            }
        </div>
    </div>

    <div class="mt-5">
        <h2><i class="bi bi-calendar3"></i> Mua vé</h2>
        <hr />

        @if (Model.AvailableDates.Any())
        {
            <ul class="nav nav-pills nav-fill mb-3" id="dateTabs" role="tablist">
                @for (var i = 0; i < Model.AvailableDates.Count; i++)
                {
                    var date = Model.AvailableDates[i];
                    var isActive = (i == 0);
                    var dateText = date == DateOnly.FromDateTime(DateTime.Now) ? "Hôm nay" : date.ToString("dddd");

                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(isActive ? "active" : "")" id="tab-@date.DayNumber" data-bs-toggle="tab" data-bs-target="#pane-@date.DayNumber" type="button" role="tab">
                            <strong>@dateText</strong>
                            <br><span class="small">@date.ToString("dd/MM")</span>
                        </button>
                    </li>
                }
            </ul>

            <div class="tab-content" id="dateTabsContent">
                @for (var i = 0; i < Model.AvailableDates.Count; i++)
                {
                    var date = Model.AvailableDates[i];
                    var isActive = (i == 0);

                    // Lấy các suất chiếu trong ngày này
                    var showtimesOnDate = Model.ShowtimesByDate[date];

                    var showtimesByRoomType = showtimesOnDate.GroupBy(s => s.RoomTypeText);

                    <div class="tab-pane fade @(isActive ? "show active" : "")" id="pane-@date.DayNumber" role="tabpanel">

                        @foreach (var typeGroup in showtimesByRoomType.OrderBy(g => g.Key))
                        {
                            var showtimesByRoomName = typeGroup.GroupBy(s => s.RoomName);

                            foreach (var roomGroup in showtimesByRoomName)
                            {
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>@typeGroup.Key</strong> (@roomGroup.Key)
                                    </div>
                                    <div class="card-body showtime-buttons">
                                        @foreach (var showtime in roomGroup.OrderBy(s => s.StartTime))
                                        {
                                            <a asp-page="/Booking/SeatMap" asp-route-showtimeId="@showtime.ShowtimeId" class="btn btn-outline-primary m-1">
                                                <strong>@showtime.StartTime.ToString("HH:mm")</strong>
                                            </a>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">Hiện chưa có lịch chiếu cho phim này.</div>
        }
    </div>
}
else
{
    <div class="alert alert-danger">
        @Model.ErrorMessage ?? "Không tìm thấy phim bạn yêu cầu."
    </div>
}